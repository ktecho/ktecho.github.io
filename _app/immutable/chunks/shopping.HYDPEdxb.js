import{H as n,S as u,am as d,a0 as i,K as m,p as S,E as h,I as p,an as y}from"./utils.FkBaGfnY.js";import{v as l}from"./scheduler.2vmdsppc.js";const _="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20fill='none'%20viewBox='0%200%2024%2024'%20stroke-width='1.5'%20stroke='currentColor'%20class='w-6%20h-6'%3e%3cpath%20stroke-linecap='round'%20stroke-linejoin='round'%20d='M2.25%2015.75l5.159-5.159a2.25%202.25%200%20013.182%200l5.159%205.159m-1.5-1.5l1.409-1.409a2.25%202.25%200%20013.182%200l2.909%202.909m-18%203.75h16.5a1.5%201.5%200%20001.5-1.5V6a1.5%201.5%200%2000-1.5-1.5H3.75A1.5%201.5%200%20002.25%206v12a1.5%201.5%200%20001.5%201.5zm10.5-11.25h.008v.008h-.008V8.25zm.375%200a.375.375%200%2011-.75%200%20.375.375%200%2001.75%200z'%20/%3e%3c/svg%3e";function I(e,t=_){e.onerror="",e.src=t}function w(e,t,s=!0){if(e.quantity!==null&&t>e.quantity)return h.set("There are just "+e.quantity+" products in stock. You cannot order "+t+"."),!1;let r=!1;u.update(o=>{let c=o.products,f=c.get(e.stall_id);if(f===void 0){let a=new Map;e.orderQuantity=t,a.set(e.id,e),c.set(e.stall_id,a),r=!0}else{let a=f.get(e.id);a===void 0?(e.orderQuantity=t,f.set(e.id,e),r=!0):e.quantity!==null&&a.orderQuantity+t>e.quantity?h.set("There are just "+e.quantity+" products in stock. You already have "+a.orderQuantity+" on your shopping card, so you cannot order "+t+" more."):(a.orderQuantity=a.orderQuantity+t,r=!0)}return r&&s&&p.set("Product added to the shopping cart."),o}),s&&g()}function b(e,t){u.update(s=>{let r=s.products,o=r.get(e);return o!==void 0&&(o.delete(t),o.size===0&&r.delete(e)),p.set("Product removed from the shopping cart."),s}),g()}function g(){let e=[];for(const[t,s]of l(u).products)for(const[r,o]of s)e.push(o);e.length>0?localStorage.setItem("shoppingCartProducts",JSON.stringify(e)):localStorage.removeItem("shoppingCartProducts")}function v(){if(l(u).products.size!==0){console.debug("Shopping Cart is not empty, so we don't restore it",l(u));return}const e=localStorage.getItem("shoppingCartProducts");if(e){const t=JSON.parse(e);for(const s of t)w(s,s.orderQuantity,!1)}}function V(){let e=Math.floor(Date.now()),t=l(n);if(t===null||t&&t.fetching!==!0&&e-t.fetched_at>6e4)console.log("************ refreshStalls - refreshing..."),t===null?t={stalls:{},fetching:!0,fetched_at:e}:(t.fetching=!0,t.fetched_at=e),n.set(t),d(null,s=>{let r=JSON.parse(s.content);if(r.createdAt=s.created_at,r.merchantPubkey=s.pubkey,!r.id){let c=y(s.tags,"d");if(c!==null)r.id=c;else return}let o=r.id;o in t.stalls?t.stalls[o].createdAt<s.created_at&&(t.stalls[o]=r):t.stalls[o]=r,n.set(t)},()=>{let s=l(n);s.fetching=!1,n.set(s)});else{console.log("************ refreshStalls - no need to refresh yet");let s=l(n);s.fetching=!1,n.set(s)}}function q(e){let t=[],s=l(n);return s!==null&&Object.entries(s.stalls).forEach(([r,o])=>{e===o.merchantPubkey&&(t[r]=o)}),t}function O(){let e=Math.floor(Date.now()),t=l(i);t===null||t&&t.fetching!==!0&&e-t.fetched_at>6e4?(console.log("************ refreshProducts - refreshing..."),t===null?t={products:{},fetching:!0,fetched_at:e}:(t.fetched_at=e,t.fetching=!0),i.set(t),m(null,null,s=>{let r=s.id;r in t.products?t.products[r].event.created_at<s.event.created_at&&(t.products[r]=s):t.products[r]=s,i.set(t)},()=>{let s=l(i);s&&(s.fetching=!1,i.set(s))})):console.log("************ refreshProducts - no need to refresh yet")}function j(){let e={};const t=l(S).automatic;return Object.entries(t).forEach(([s,r])=>{r.paid||(r.name&&(e.name=r.name),r.address&&(e.address=r.address),r.contact?.phone&&(e.phone=r.contact.phone),r.contact?.email&&(e.email=r.contact.email))}),e}export{v as a,O as b,w as c,b as d,q as e,j as g,I as o,_ as p,V as r,g as s};
