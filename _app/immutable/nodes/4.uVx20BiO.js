import{s as Ee,a as H,e as ge,U as Me,d,c as K,i as j,y as ie,T as je,o as Ce,l as J,m as W,f as I,g as O,F as Ae,j as A,r as ae,p as $,h as S,O as be,z as y,G as Le,Y as x,n as fe}from"../chunks/scheduler.2vmdsppc.js";import{S as Pe,i as Ue,b as oe,d as re,m as le,t as te,c as He,a as se,e as ce,g as Ke,o as ee}from"../chunks/index.eLAHt3dB.js";import{g as Ve,r as Be,o as Ye,p as ye}from"../chunks/shopping.HYDPEdxb.js";import{b as ke,y as Ge,P as Te,K as qe,v as Fe,Q as Je,I as We,E as we,R as ze,H as Qe,p as Xe,T as Ze,U as $e,M as Ne}from"../chunks/utils.FkBaGfnY.js";import{T as xe}from"../chunks/Title-h1.ksZwEtxJ.js";import{S as et,a as tt}from"../chunks/ShippingOptions.5yoMSw42.js";function st(s){let t;return{c(){t=J("Auction information")},l(e){t=W(e,"Auction information")},m(e,n){j(e,t,n)},d(e){e&&d(t)}}}function nt(s){let t,e='<div class="p-6 text-lg"><p>You didn&#39;t win any auction yet that you must provide information for.</p> <p class="mt-4">You can <a class="text-blue-500" href="/stalls">browse stalls</a> and buy some products.</p></div>';return{c(){t=I("div"),t.innerHTML=e,this.h()},l(n){t=O(n,"DIV",{class:!0,"data-svelte-h":!0}),Ae(t)!=="svelte-1n99u5h"&&(t.innerHTML=e),this.h()},h(){A(t,"class","grid justify-center items-center lg:mx-20 gap-6 lg:gap-20 place-content-center")},m(n,a){j(n,t,a)},p:ae,i:ae,o:ae,d(n){n&&d(t)}}}function it(s){let t,e,n,a,r='<tr class="text-center"><th>Name</th> <th>Image</th> <th class="p-2">Winning bid</th></tr>',l,g,w,b,_,o,p,R,f,C,V,E,Y,z,L,G,N,Q,c,v,U,D,m,P,X,u=s[7][0][1].id&&ve(s);w=new et({props:{stallId:s[8]}});let h=s[1].name&&Ie(s),k=s[9][0][1].amount&&Oe(s);function ne(i){s[14](i)}function Z(i){s[15](i)}function De(i){s[16](i)}function Re(i){s[17](i)}function Se(i){s[18](i)}let q={buyNow:s[0],isAuction:!0};return s[2]!==void 0&&(q.name=s[2]),s[3]!==void 0&&(q.address=s[3]),s[4]!==void 0&&(q.message=s[4]),s[6]!==void 0&&(q.email=s[6]),s[5]!==void 0&&(q.phone=s[5]),N=new tt({props:q}),$.push(()=>ee(N,"name",ne)),$.push(()=>ee(N,"address",Z)),$.push(()=>ee(N,"message",De)),$.push(()=>ee(N,"email",Re)),$.push(()=>ee(N,"phone",Se)),{c(){t=I("div"),u&&u.c(),e=H(),n=I("table"),a=I("thead"),a.innerHTML=r,l=H(),g=I("tbody"),oe(w.$$.fragment),b=H(),_=I("tr"),o=I("td"),p=I("p"),h&&h.c(),R=H(),f=I("td"),C=I("div"),V=I("figure"),E=I("img"),z=H(),L=I("td"),k&&k.c(),G=H(),oe(N.$$.fragment),this.h()},l(i){t=O(i,"DIV",{class:!0});var T=S(t);u&&u.l(T),e=K(T),n=O(T,"TABLE",{class:!0});var B=S(n);a=O(B,"THEAD",{"data-svelte-h":!0}),Ae(a)!=="svelte-1a4oqkj"&&(a.innerHTML=r),l=K(B),g=O(B,"TBODY",{});var M=S(g);re(w.$$.fragment,M),b=K(M),_=O(M,"TR",{class:!0});var F=S(_);o=O(F,"TD",{class:!0});var pe=S(o);p=O(pe,"P",{class:!0});var ue=S(p);h&&h.l(ue),ue.forEach(d),pe.forEach(d),R=K(F),f=O(F,"TD",{class:!0});var de=S(f);C=O(de,"DIV",{class:!0});var me=S(C);V=O(me,"FIGURE",{});var he=S(V);E=O(he,"IMG",{class:!0,src:!0}),he.forEach(d),me.forEach(d),de.forEach(d),z=K(F),L=O(F,"TD",{class:!0});var _e=S(L);k&&k.l(_e),_e.forEach(d),F.forEach(d),M.forEach(d),B.forEach(d),T.forEach(d),G=K(i),re(N.$$.fragment,i),this.h()},h(){A(p,"class","pl-3 text-center"),A(o,"class","py-1"),A(E,"class","rounded-xl"),be(E.src,Y=s[1].images?s[1].images[0]:s[1].image??ye)||A(E,"src",Y),A(C,"class","card shadow-xl w-20 md:w-20"),A(f,"class","py-2 px-4"),A(L,"class","py-1"),A(_,"class","border-b border-gray-600 hover text-sm md:text-base text-center"),A(n,"class","w-fit md:w-full rounded border border-gray-400"),A(t,"class","md:grid justify-center md:mt-6 mb-10")},m(i,T){j(i,t,T),u&&u.m(t,null),y(t,e),y(t,n),y(n,a),y(n,l),y(n,g),le(w,g,null),y(g,b),y(g,_),y(_,o),y(o,p),h&&h.m(p,null),y(_,R),y(_,f),y(f,C),y(C,V),y(V,E),y(_,z),y(_,L),k&&k.m(L,null),j(i,G,T),le(N,i,T),m=!0,P||(X=Le(E,"error",s[13]),P=!0)},p(i,T){i[7][0][1].id?u?u.p(i,T):(u=ve(i),u.c(),u.m(t,e)):u&&(u.d(1),u=null);const B={};T&256&&(B.stallId=i[8]),w.$set(B),i[1].name?h?h.p(i,T):(h=Ie(i),h.c(),h.m(p,null)):h&&(h.d(1),h=null),(!m||T&2&&!be(E.src,Y=i[1].images?i[1].images[0]:i[1].image??ye))&&A(E,"src",Y),i[9][0][1].amount?k?k.p(i,T):(k=Oe(i),k.c(),k.m(L,null)):k&&(k.d(1),k=null);const M={};!Q&&T&4&&(Q=!0,M.name=i[2],x(()=>Q=!1)),!c&&T&8&&(c=!0,M.address=i[3],x(()=>c=!1)),!v&&T&16&&(v=!0,M.message=i[4],x(()=>v=!1)),!U&&T&64&&(U=!0,M.email=i[6],x(()=>U=!1)),!D&&T&32&&(D=!0,M.phone=i[5],x(()=>D=!1)),N.$set(M)},i(i){m||(se(w.$$.fragment,i),se(N.$$.fragment,i),m=!0)},o(i){te(w.$$.fragment,i),te(N.$$.fragment,i),m=!1},d(i){i&&(d(t),d(G)),u&&u.d(),ce(w),h&&h.d(),k&&k.d(),ce(N,i),P=!1,X()}}}function ve(s){let t,e,n=s[7][0][1].id+"",a;return{c(){t=I("p"),e=J("Auction #"),a=J(n),this.h()},l(r){t=O(r,"P",{class:!0});var l=S(t);e=W(l,"Auction #"),a=W(l,n),l.forEach(d),this.h()},h(){A(t,"class","text-sm mb-2 justify-center")},m(r,l){j(r,t,l),y(t,e),y(t,a)},p(r,l){l&128&&n!==(n=r[7][0][1].id+"")&&fe(a,n)},d(r){r&&d(t)}}}function Ie(s){let t=s[1].name+"",e;return{c(){e=J(t)},l(n){e=W(n,t)},m(n,a){j(n,e,a)},p(n,a){a&2&&t!==(t=n[1].name+"")&&fe(e,t)},d(n){n&&d(e)}}}function Oe(s){let t,e=s[9][0][1].amount+"",n,a;return{c(){t=I("p"),n=J(e),a=J(" sats"),this.h()},l(r){t=O(r,"P",{class:!0});var l=S(t);n=W(l,e),a=W(l," sats"),l.forEach(d),this.h()},h(){A(t,"class","pr-2 text-center")},m(r,l){j(r,t,l),y(t,n),y(t,a)},p(r,l){l&512&&e!==(e=r[9][0][1].amount+"")&&fe(n,e)},d(r){r&&d(t)}}}function at(s){let t,e,n,a,r,l,g;e=new xe({props:{$$slots:{default:[st]},$$scope:{ctx:s}}});const w=[it,nt],b=[];function _(o,p){return o[8]&&o[1]&&o[9].length>0?0:1}return a=_(s),r=b[a]=w[a](s),{c(){t=H(),oe(e.$$.fragment),n=H(),r.c(),l=ge(),this.h()},l(o){Me("svelte-1ityo7y",document.head).forEach(d),t=K(o),re(e.$$.fragment,o),n=K(o),r.l(o),l=ge(),this.h()},h(){document.title="Auction information"},m(o,p){j(o,t,p),le(e,o,p),j(o,n,p),b[a].m(o,p),j(o,l,p),g=!0},p(o,[p]){const R={};p&2097152&&(R.$$scope={dirty:p,ctx:o}),e.$set(R);let f=a;a=_(o),a===f?b[a].p(o,p):(Ke(),te(b[f],1,1,()=>{b[f]=null}),He(),r=b[a],r?r.p(o,p):(r=b[a]=w[a](o),r.c()),se(r,1),r.m(l.parentNode,l))},i(o){g||(se(e.$$.fragment,o),se(r),g=!0)},o(o){te(e.$$.fragment,o),te(r),g=!1},d(o){o&&(d(t),d(n),d(l)),ce(e,o),b[a].d(o)}}}function ot(s,t,e){let n,a,r;ie(s,Qe,c=>e(19,n=c)),ie(s,ke,c=>e(11,a=c)),ie(s,Xe,c=>e(12,r=c));let l=null,g=null,w=null,b=null,_=null,o,p,R,f=[],C=[];async function V(){if(console.log("---- buyNow start ----"),!await Te())return;if(n.stalls[p].shippingOption==="0"){we.set("You must choose shipping options for each order.");return}let c={id:o[0][0],stall_id:p,type:0,contact:{nostr:a},shipping_id:n.stalls[p].shippingOption};l&&l!==""&&(c.name=l),g&&g!==""&&(c.address=g),w&&w!==""&&(c.message=w),b&&b!==""&&(c.contact.phone=b),_&&_!==""&&(c.contact.email=_);try{let v=JSON.stringify(c);console.log("************ jsonOrder:  ",c),await Je(n.stalls[p].merchantPubkey,v,!1,async U=>{console.log("-------- Order accepted by relay:",U),await new Promise(D=>setTimeout(D,3500)),await Fe("/orders")}),We.set("Information for the auction have been sent."),console.log("---- buyNow end ----")}catch(v){we.set("There was an error trying to send the information for the auction. Check that you have a Nostr extension in the browser or you have generated the Nostr key correctly."),console.log("Error trying to create the order for the auction:",v)}}const E=ke.subscribe(async c=>{if(c){const v=Ve();e(2,l=v.name??""),e(3,g=v.address??""),e(5,b=v.phone??""),e(6,_=v.email??"")}});je(E),Ce(async()=>{Be()}),Ge(async()=>{await Te()});const Y=c=>Ye(c.srcElement);function z(c){l=c,e(2,l)}function L(c){g=c,e(3,g)}function G(c){w=c,e(4,w)}function N(c){_=c,e(6,_)}function Q(c){b=c,e(5,b)}return s.$$.update=()=>{if(s.$$.dirty&7170){let c=!1;e(7,o=Object.entries(r.automatic).filter(([,v])=>{if(!c&&v.type===10){const U=v.items[0].product_id;if(U)return c=!0,qe(null,[U],D=>{(!R||R&&D.event.created_at>R.event.created_at)&&(e(1,R=D),e(8,p=D.stall_id),D.event.id&&ze([D.event.id],m=>{if(m.kind===Ze)f[m.id]===void 0&&e(10,f[m.id]={},f),e(10,f[m.id].amount=Number(m.content),f),e(10,f[m.id].date=m.created_at,f),e(10,f[m.id].pubkey=m.pubkey,f),f[m.id].backendResponse||e(10,f[m.id].backendResponse=null,f);else if(m.kind===$e){if(m.pubkey!==D.event.pubkey){console.error("WARNING! Someone tried to cheat on the auction, but we caught them!");return}try{let P=JSON.parse(m.content);if(P.status==="winner"){const X=Ne(m.tags,"e");for(let u=0;u<X.length;u++){let h=X[u][1];if(D.event.id!==h){f[h]===void 0&&e(10,f[h]={backendResponse:null},f);let k=f[h];const ne=Ne(m.tags,"p");for(let Z=0;Z<ne.length;Z++)P.winnerPubkey=ne[Z][1];k.backendResponse=P,e(10,f[h]=k,f)}}e(9,C=Object.entries(f).filter(([,u])=>u.backendResponse===null?!1:u.backendResponse.status==="winner"&&u.backendResponse.winnerPubkey===a))}}catch(P){console.error("Error parsing bid response:",P)}}}))}),!0}return!1}))}},[V,R,l,g,w,b,_,o,p,C,f,a,r,Y,z,L,G,N,Q]}class dt extends Pe{constructor(t){super(),Ue(this,t,ot,at,Ee,{buyNow:0})}get buyNow(){return this.$$.ctx[0]}}export{dt as component};
